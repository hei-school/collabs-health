name: Status Webhook

on:
  push:
    branches:
      - "*"
  workflow_dispatch:
  schedule:
    - cron: "*/5 8-17 * * 1-5" # Runs every 5 minutes from 8 AM to 5 PM (UTC+3) on weekdays

env:
  OWNCLOUD_WEBHOOK_URL: ${{ secrets.OWNCLOUD_WEBHOOK_URL }}
  MAIL_WEBHOOK_URL: ${{ secrets.MAIL_WEBHOOK_URL }}
  OWNCLOUD_TEMPLATE_OUTAGE: ${{ secrets.OWNCLOUD_TEMPLATE_OUTAGE }}
  OWNCLOUD_TEMPLATE_RESOLVED: ${{ secrets.OWNCLOUD_TEMPLATE_RESOLVED }}
  MAIL_TEMPLATE_OUTAGE: ${{ secrets.MAIL_TEMPLATE_OUTAGE }}
  MAIL_TEMPLATE_RESOLVED: ${{ secrets.MAIL_TEMPLATE_RESOLVED }}

jobs:
  check-status:
    runs-on: ubuntu-latest

    steps:
      - name: Check health-owncloud workflow status
        id: owncloud-status
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'health-owncloud.yml',
              per_page: 1
            });
            const lastRun = response.data.workflow_runs[0];
            return lastRun.conclusion === 'success';

      - name: Check health-mail workflow status
        id: mail-status
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'health-mail.yml',
              per_page: 1
            });
            const lastRun = response.data.workflow_runs[0];
            return lastRun.conclusion === 'success';

      - name: Set trigger and template for ownCloud
        id: owncloud-template
        run: |
          if [ '${{ steps.owncloud-status.outputs.result }}' == 'true' ]; then
            echo "owncloud_trigger=up" >> $GITHUB_ENV
            echo "owncloud_template=$OWNCLOUD_TEMPLATE_RESOLVED" >> $GITHUB_ENV
          else
            echo "owncloud_trigger=down" >> $GITHUB_ENV
            echo "owncloud_template=$OWNCLOUD_TEMPLATE_OUTAGE" >> $GITHUB_ENV
          fi

      - name: Set trigger and template for Mail
        id: mail-template
        run: |
          if [ '${{ steps.mail-status.outputs.result }}' == 'true' ]; then
            echo "mail_trigger=up" >> $GITHUB_ENV
            echo "mail_template=$MAIL_TEMPLATE_RESOLVED" >> $GITHUB_ENV
          else
            echo "mail_trigger=down" >> $GITHUB_ENV
            echo "mail_template=$MAIL_TEMPLATE_OUTAGE" >> $GITHUB_ENV
          fi

      - name: Send status for ownCloud
        run: |
          curl -X POST "$OWNCLOUD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "trigger": "'"$owncloud_trigger"'",
            "createTemplate": "'"$owncloud_template"'",
            "status": "'"$owncloud_trigger"'"
          }'

      - name: Send status for Mail
        run: |
          curl -X POST "$MAIL_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "trigger": "'"$mail_trigger"'",
            "resolveTemplate": "'"$mail_template"'"
          }'

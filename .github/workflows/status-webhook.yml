name: Status Webhook

on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"
  workflow_dispatch:
  schedule:
    - cron: "*/5 8-17 * * 1-5" # Exécuter toutes les 5 minutes de 8h à 17h (UTC+3) pendant les jours ouvrables

env:
  TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
  OWNCLOUD_WEBHOOK_URL: ${{ secrets.OWNCLOUD_WEBHOOK_URL }}
  MAIL_WEBHOOK_URL: ${{ secrets.MAIL_WEBHOOK_URL }}
  OWNCLOUD_TEMPLATE_OUTAGE: ${{ secrets.OWNCLOUD_TEMPLATE_OUTAGE }}
  OWNCLOUD_TEMPLATE_RESOLVED: ${{ secrets.OWNCLOUD_TEMPLATE_RESOLVED }}
  MAIL_TEMPLATE_OUTAGE: ${{ secrets.MAIL_TEMPLATE_OUTAGE }}
  MAIL_TEMPLATE_RESOLVED: ${{ secrets.MAIL_TEMPLATE_RESOLVED }}

jobs:
  check-status:
    runs-on: ubuntu-latest

    steps:
      - name: Get health-owncloud workflow status
        id: owncloud-status
        run: |
          response=$(curl -s -H "Authorization: Bearer $TOKEN_GITHUB" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/health-owncloud.yml/runs?branch=${{ github.ref_name }}&per_page=1")
          conclusion=$(echo "$response" | jq -r '.workflow_runs[0].conclusion')
          if [ "$conclusion" = "success" ]; then
            echo "owncloud_trigger=up" >> $GITHUB_ENV
            echo "owncloud_template=$OWNCLOUD_TEMPLATE_RESOLVED" >> $GITHUB_ENV
          else
            echo "owncloud_trigger=down" >> $GITHUB_ENV
            echo "owncloud_template=$OWNCLOUD_TEMPLATE_OUTAGE" >> $GITHUB_ENV
          fi

      - name: Get health-mail workflow status
        id: mail-status
        run: |
          response=$(curl -s -H "Authorization: Bearer $TOKEN_GITHUB" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/health-mail.yml/runs?branch=${{ github.ref_name }}&per_page=1")
          conclusion=$(echo "$response" | jq -r '.workflow_runs[0].conclusion')
          if [ "$conclusion" = "success" ]; then
            echo "mail_trigger=up" >> $GITHUB_ENV
            echo "mail_template=$MAIL_TEMPLATE_RESOLVED" >> $GITHUB_ENV
          else
            echo "mail_trigger=down" >> $GITHUB_ENV
            echo "mail_template=$MAIL_TEMPLATE_OUTAGE" >> $GITHUB_ENV
          fi

      - name: Send status for ownCloud
        run: |
          echo $owncloud_template
          echo $owncloud_trigger
          curl -X POST "$OWNCLOUD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "trigger": "$owncloud_trigger",
            "createTemplate": "$owncloud_template",
            "status": "$owncloud_trigger"
          }'

      - name: Send status for Mail
        run: |
          echo
          curl -X POST "$MAIL_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "trigger": "$mail_trigger",
            "resolveTemplate": "$mail_template"
          }'
